# Docker Compose configuration for Nachos development
# This file defines all core services with hot-reload support

# ==================== Networks ====================
networks:
  # Internal network - no external access
  # All core components communicate through this isolated network
  nachos-internal:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  # Egress network - controlled external access
  # Only components that need internet access join this network
  nachos-egress:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ==================== Volumes ====================
volumes:
  # NATS JetStream data
  nats-data:
  # Redis data for shared state (rate limits, session routing)
  redis-data:
  # Logs aggregation
  nachos-logs:

# ==================== Services ====================
services:
  # -------------------- Message Bus --------------------
  bus:
    container_name: nachos-bus
    build:
      context: .
      dockerfile: packages/core/bus/Dockerfile
    image: nachos-bus:dev
    restart: unless-stopped
    
    networks:
      - nachos-internal
    
    ports:
      - "4222:4222"  # NATS client connections
      - "8222:8222"  # NATS HTTP monitoring
    
    volumes:
      - nats-data:/data
      - ./docker/nats/nats-server.conf:/etc/nats/nats-server.conf:ro
      - nachos-logs:/var/log/nachos
    
    command: ["-c", "/etc/nats/nats-server.conf"]
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=bus"

  # -------------------- Gateway (with embedded Salsa) --------------------
  # Salsa security layer is embedded in Gateway for performance
  # See ADR-004: Embedded Salsa & Shardable Gateway
  gateway:
    container_name: nachos-gateway
    build:
      context: .
      dockerfile: packages/core/gateway/Dockerfile
    image: nachos-gateway:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - nachos-internal

    ports:
      - "3000:3000"

    environment:
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - REDIS_URL=redis://redis:6379
      - PORT=3000
      - LOG_LEVEL=debug
      - SECURITY_MODE=${SECURITY_MODE:-standard}
      - GATEWAY_RATE_LIMIT_ENABLED=${GATEWAY_RATE_LIMIT_ENABLED:-true}
      - SECURITY_RATE_LIMIT_MESSAGES=${SECURITY_RATE_LIMIT_MESSAGES:-30}
      - SECURITY_RATE_LIMIT_TOOLS=${SECURITY_RATE_LIMIT_TOOLS:-15}
      - SECURITY_RATE_LIMIT_LLM=${SECURITY_RATE_LIMIT_LLM:-30}
    
    volumes:
      # Mount source code for hot-reload
      - ./packages/core/gateway/src:/app/packages/core/gateway/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - ./tsconfig.base.json:/app/tsconfig.base.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      # Security policies (hot-reload enabled)
      - ./policies:/app/policies:ro
      # Gateway data (SQLite sessions, audit logs)
      - ./data/gateway:/app/data
      # Cache node_modules to avoid reinstalling
      - /app/node_modules
      - /app/packages/core/gateway/node_modules
      # Logs
      - nachos-logs:/var/log/nachos

    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=gateway"

  # -------------------- Redis (Shared State) --------------------
  # Used for rate limiting, session routing, and cross-instance state
  # See ADR-004: Embedded Salsa & Shardable Gateway
  redis:
    container_name: nachos-redis
    image: redis:7-alpine
    restart: unless-stopped

    networks:
      - nachos-internal

    ports:
      - "6379:6379"

    volumes:
      - redis-data:/data

    command: ["redis-server", "--appendonly", "yes"]

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=redis"

  # -------------------- LLM Proxy --------------------
  llm-proxy:
    container_name: nachos-llm-proxy
    build:
      context: .
      dockerfile: packages/core/llm-proxy/Dockerfile
    image: nachos-llm-proxy:dev
    restart: unless-stopped
    
    depends_on:
      bus:
        condition: service_healthy
    
    networks:
      - nachos-internal
      - nachos-egress  # Needs external access for LLM APIs
    
    ports:
      - "3001:3001"
    
    environment:
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - PORT=3001
      - LOG_LEVEL=debug
      # LLM API keys - set these in .env file
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    
    volumes:
      # Mount source code for hot-reload
      - ./packages/core/llm-proxy/src:/app/packages/core/llm-proxy/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - ./tsconfig.base.json:/app/tsconfig.base.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      # Cache node_modules
      - /app/node_modules
      - /app/packages/core/llm-proxy/node_modules
      # Logs
      - nachos-logs:/var/log/nachos
    
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=llm-proxy"

  # NOTE: Salsa (Policy Engine) is now embedded in Gateway
  # See ADR-004: Embedded Salsa & Shardable Gateway Architecture
  # The packages/core/salsa directory contains the library code used by Gateway

  # ==================== Tools (Phase 6) ====================

  # -------------------- Filesystem Read Tool --------------------
  filesystem-read:
    container_name: nachos-tool-filesystem-read
    build:
      context: .
      dockerfile: packages/tools/filesystem/Dockerfile
    image: nachos-tool-filesystem:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal

    environment:
      - TOOL_MODE=read
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - ALLOWED_PATHS=./workspace
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./workspace:/workspace:ro  # Read-only mount
      - ./packages/tools/filesystem/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=filesystem-read"

  # -------------------- Filesystem Write Tool --------------------
  filesystem-write:
    container_name: nachos-tool-filesystem-write
    build:
      context: .
      dockerfile: packages/tools/filesystem/Dockerfile
    image: nachos-tool-filesystem:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal

    environment:
      - TOOL_MODE=write
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - ALLOWED_PATHS=./workspace
      - MAX_FILE_SIZE=10MB
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./workspace:/workspace:rw  # Read-write mount
      - ./packages/tools/filesystem/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=filesystem-write"

  # -------------------- Filesystem Edit Tool --------------------
  filesystem-edit:
    container_name: nachos-tool-filesystem-edit
    build:
      context: .
      dockerfile: packages/tools/filesystem/Dockerfile
    image: nachos-tool-filesystem:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal

    environment:
      - TOOL_MODE=edit
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - ALLOWED_PATHS=./workspace
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./workspace:/workspace:rw
      - ./packages/tools/filesystem/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=filesystem-edit"

  # -------------------- Filesystem Patch Tool --------------------
  filesystem-patch:
    container_name: nachos-tool-filesystem-patch
    build:
      context: .
      dockerfile: packages/tools/filesystem/Dockerfile
    image: nachos-tool-filesystem:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal

    environment:
      - TOOL_MODE=patch
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - ALLOWED_PATHS=./workspace
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./workspace:/workspace:rw
      - ./packages/tools/filesystem/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=filesystem-patch"

  # -------------------- Browser Tool --------------------
  browser:
    container_name: nachos-tool-browser
    build:
      context: .
      dockerfile: packages/tools/browser/Dockerfile
    image: nachos-tool-browser:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal
      - nachos-egress  # Needs external access for web browsing

    environment:
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - ALLOWED_DOMAINS=${BROWSER_ALLOWED_DOMAINS:-*}
      - BROWSER_HEADLESS=${BROWSER_HEADLESS:-true}
      - BROWSER_TIMEOUT_MS=${BROWSER_TIMEOUT_MS:-30000}
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./workspace/browser-downloads:/downloads:rw
      - ./packages/tools/browser/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "pwuser"

    shm_size: 512m
    mem_limit: 1g

    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=browser"

  # -------------------- Code Runner - Python --------------------
  code-runner-python:
    container_name: nachos-tool-code-python
    build:
      context: .
      dockerfile: packages/tools/code-runner/Dockerfile.python
    image: nachos-tool-code-python:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal  # NO external access

    environment:
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - LANGUAGE=python
      - EXECUTION_TIMEOUT=${CODE_EXECUTION_TIMEOUT:-30}
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./packages/tools/code-runner/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

    mem_limit: 256m
    cpus: 0.5
    pids_limit: 50

    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=code-runner-python"

  # -------------------- Code Runner - JavaScript --------------------
  code-runner-javascript:
    container_name: nachos-tool-code-javascript
    build:
      context: .
      dockerfile: packages/tools/code-runner/Dockerfile.javascript
    image: nachos-tool-code-javascript:dev
    restart: unless-stopped

    depends_on:
      bus:
        condition: service_healthy

    networks:
      - nachos-internal  # NO external access

    environment:
      - NODE_ENV=development
      - NATS_URL=nats://bus:4222
      - LANGUAGE=javascript
      - EXECUTION_TIMEOUT=${CODE_EXECUTION_TIMEOUT:-30}
      - SECURITY_MODE=${SECURITY_MODE:-standard}

    volumes:
      - ./packages/tools/code-runner/src:/app/src:ro
      - ./packages/shared:/app/packages/shared:ro
      - nachos-logs:/var/log/nachos

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

    mem_limit: 256m
    cpus: 0.5
    pids_limit: 50

    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=code-runner-javascript"
