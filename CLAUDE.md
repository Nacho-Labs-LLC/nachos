# CLAUDE.md - Nachos Project Context

> **Purpose**: Succinct context for AI agents working on this codebase.
> Keep this file updated as the project evolves.

## What is Nachos?

Nachos is a **Docker-native, security-first, modular AI assistant framework**. It enables users to run personal AI agents that connect to messaging platforms (Slack, Discord, Telegram, etc.) while maintaining strong security defaults and easy customization.

**Key differentiator**: Unlike monolithic assistants, Nachos uses a "build your own plate" approach—every component (channels, tools, security policies) runs as an isolated container that users compose together.

## Architecture Mental Model

Think of it like nachos (the food):
- **Chips** = Core runtime (Gateway + Bus) — always required
- **Cheese** = Message bus — binds everything together
- **Protein** = LLM provider — the substance (Claude, GPT, Ollama)
- **Toppings** = Channels & Tools — add what you want
- **Salsa** = Security policies — protection layer
- **The Plate** = Docker Compose — serves everything

```
┌─────────────────────────────────────────────────────┐
│                  Docker Compose                      │
│  ┌───────────────────────────────────────────────┐  │
│  │              Salsa (Policy Engine)            │  │
│  └───────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────┐  │
│  │              Bus (NATS/Redis)                 │  │
│  └───────────────────────────────────────────────┘  │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │ Gateway │ │LLM Proxy│ │Channels │ │  Tools  │  │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │
│  ┌───────────────────────────────────────────────┐  │
│  │         Internal Network (isolated)           │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

## Repository Structure

```
nachos/
├── CLAUDE.md              # This file - AI context
├── nachos.toml.example    # Example configuration
├── docker-compose.yml     # Generated by CLI
├── cli/                   # Nachos CLI tool
│   └── src/
├── core/                  # Core containers
│   ├── gateway/           # Session management, routing
│   ├── bus/               # Message passing (NATS)
│   ├── llm-proxy/         # LLM provider abstraction
│   └── salsa/             # Policy engine
├── channels/              # Channel adapters
│   ├── slack/
│   ├── discord/
│   ├── telegram/
│   └── webchat/
├── tools/                 # Tool containers
│   ├── browser/
│   ├── filesystem/
│   └── code-runner/
├── skills/                # Bundled prompt+tool recipes
├── policies/              # Default security policies
└── docs/                  # Documentation
```

## Core Concepts

### 1. Security Modes
Three presets (strict > standard > permissive):
- **Strict** (default): All tools disabled, allowlist DMs, full audit
- **Standard**: Common tools enabled, pairing-based DMs
- **Permissive**: Full access (requires explicit opt-in)

### 2. Module Manifest
Every channel/tool declares capabilities via `manifest.json`:
```json
{
  "name": "nachos-channel-slack",
  "type": "channel",
  "capabilities": {
    "network": ["slack.com"],
    "secrets": ["SLACK_BOT_TOKEN"]
  }
}
```

### 3. Message Flow
```
User Message → Channel Container → Bus → Gateway → LLM Proxy → LLM
                                              ↓
                                         Salsa (policy check)
                                              ↓
                                     Tool Container (if needed)
                                              ↓
                                        Response → Bus → Channel → User
```

### 4. Network Isolation
- `nachos-internal`: No external access, inter-container only
- `nachos-egress`: Controlled external access (LLM API, channel APIs)
- Containers only join networks they need per manifest

## Key Files to Know

| File | Purpose |
|------|---------|
| `nachos.toml` | Single config file for entire stack |
| `core/gateway/src/router.ts` | Message routing logic |
| `core/salsa/src/policy.ts` | Policy enforcement |
| `core/bus/src/topics.ts` | Message bus topic definitions |
| `cli/src/commands/` | CLI command implementations |

## Development Commands

```bash
# Start full stack
nachos up

# Start with specific modules
nachos up --only gateway,bus,slack

# Add a module
nachos add channel telegram

# Run tests
nachos test

# View aggregated logs
nachos logs

# Health check
nachos doctor
```

## Coding Conventions

- **Language**: TypeScript for all containers
- **Runtime**: Node.js 22+ with native ESM
- **Package Manager**: pnpm (workspaces)
- **Container Base**: `node:22-alpine`
- **Message Format**: JSON over NATS
- **Config Format**: TOML (nachos.toml)

## Security Principles

1. **Deny by default**: Capabilities must be explicitly granted
2. **Least privilege containers**: Non-root, read-only FS, dropped caps
3. **Network isolation**: Internal network by default
4. **Policy as code**: All security rules in `policies/`
5. **Audit everything**: All actions logged with attribution

## Common Tasks

### Adding a New Channel
1. Scaffold: `nachos create channel my-channel`
2. Implement adapter in `channels/my-channel/src/`
3. Define manifest with required capabilities
4. Add to compose generation in CLI

### Adding a New Tool
1. Scaffold: `nachos create tool my-tool`
2. Implement tool interface in `tools/my-tool/src/`
3. Define security tier in manifest
4. Register tool schema with gateway

### Modifying Security Policies
1. Edit `policies/default.yaml`
2. Test with `nachos policy validate`
3. Policies hot-reload on change

## Current Status

> Update this section as development progresses

- [ ] **Phase 1**: Core infrastructure (Gateway, Bus, LLM Proxy)
- [ ] **Phase 2**: Security layer (Salsa policy engine)
- [ ] **Phase 3**: First channels (Webchat, Slack)
- [ ] **Phase 4**: CLI tooling
- [ ] **Phase 5**: Additional channels + tools

## Known Constraints

- Docker required (no native install path)
- Single-user focused (not multi-tenant)
- LLM API keys managed by user
- No persistent storage beyond volume mounts

## Getting Help

- Check `docs/` for detailed documentation
- Run `nachos doctor` for diagnostics
- Issues: GitHub Issues with `[component]` prefix
