# Nachos Default Security Policies - Standard Mode
#
# Standard mode provides balanced security:
# - Common tools enabled (browser, filesystem read, etc.)
# - Pairing-based DM approval
# - Audit logging
# - Controlled filesystem access (./workspace only)
# - Limited network egress

version: "1.0"

metadata:
  name: "Standard Mode Security Policies"
  description: "Balanced security for typical use cases"
  mode: "standard"

rules:
  # ============================================================================
  # LLM Access - Always allowed
  # ============================================================================
  - id: "standard-llm-allow"
    description: "Allow LLM calls in standard mode"
    priority: 1000
    match:
      resource: "llm"
      action: "call"
    effect: "allow"

  # ============================================================================
  # DM Access - Pairing-based approval
  # ============================================================================
  - id: "standard-dm-paired-allow"
    description: "Allow DMs from paired users in standard mode"
    priority: 900
    match:
      resource: "dm"
      action: "send"
    conditions:
      - field: "metadata.is_paired"
        operator: "equals"
        value: true
    effect: "allow"

  - id: "standard-dm-unpaired-deny"
    description: "Deny DMs from unpaired users"
    priority: 899
    match:
      resource: "dm"
      action: "send"
    effect: "deny"
    reason: "DM access requires pairing. User must complete pairing process."

  # ============================================================================
  # Channel Messages - Allow
  # ============================================================================
  - id: "standard-channel-allow"
    description: "Allow channel messages in standard mode"
    priority: 850
    match:
      resource: "channel"
      action: ["send", "receive"]
    effect: "allow"

  # ============================================================================
  # Tools - Common tools enabled
  # ============================================================================

  # Browser tool - Standard tier, allowed with SSRF protection
  - id: "standard-tool-browser"
    description: "Allow browser tool (SecurityTier: STANDARD)"
    priority: 800
    match:
      resource: "tool"
      resourceId: "browser"
    effect: "allow"
    audit: true

  # Filesystem Read - Safe tier, workspace only
  - id: "standard-tool-filesystem-read"
    description: "Allow filesystem read tool (SecurityTier: SAFE) in workspace"
    priority: 750
    match:
      resource: "tool"
      resourceId: "filesystem_read"
    conditions:
      - field: "parameters.path"
        operator: "starts_with"
        value: "./workspace"
    effect: "allow"

  - id: "standard-tool-filesystem-read-deny-outside"
    description: "Deny filesystem read outside workspace"
    priority: 749
    match:
      resource: "tool"
      resourceId: "filesystem_read"
    effect: "deny"
    reason: "Filesystem read is restricted to ./workspace directory"

  # Filesystem Write - Elevated tier, workspace only with file size limit
  - id: "standard-tool-filesystem-write"
    description: "Allow filesystem write tool (SecurityTier: ELEVATED) in workspace"
    priority: 740
    match:
      resource: "tool"
      resourceId: "filesystem_write"
    conditions:
      - field: "parameters.path"
        operator: "starts_with"
        value: "./workspace"
      - field: "parameters.size"
        operator: "less_than"
        value: 10485760  # 10MB
    effect: "allow"
    audit: true
    dlp_scan: true  # Scan content before write

  - id: "standard-tool-filesystem-write-deny-outside"
    description: "Deny filesystem write outside workspace"
    priority: 739
    match:
      resource: "tool"
      resourceId: "filesystem_write"
    effect: "deny"
    reason: "Filesystem write is restricted to ./workspace directory"

  # Filesystem Edit - Elevated tier, workspace only
  - id: "standard-tool-filesystem-edit"
    description: "Allow filesystem edit tool (SecurityTier: ELEVATED) in workspace"
    priority: 730
    match:
      resource: "tool"
      resourceId: "filesystem_edit"
    conditions:
      - field: "parameters.path"
        operator: "starts_with"
        value: "./workspace"
    effect: "allow"
    audit: true

  - id: "standard-tool-filesystem-edit-deny-outside"
    description: "Deny filesystem edit outside workspace"
    priority: 729
    match:
      resource: "tool"
      resourceId: "filesystem_edit"
    effect: "deny"
    reason: "Filesystem edit is restricted to ./workspace directory"

  # Filesystem Patch - Elevated tier, workspace only
  - id: "standard-tool-filesystem-patch"
    description: "Allow filesystem patch tool (SecurityTier: ELEVATED) in workspace"
    priority: 720
    match:
      resource: "tool"
      resourceId: "filesystem_patch"
    conditions:
      - field: "parameters.path"
        operator: "starts_with"
        value: "./workspace"
    effect: "allow"
    audit: true

  - id: "standard-tool-filesystem-patch-deny-outside"
    description: "Deny filesystem patch outside workspace"
    priority: 719
    match:
      resource: "tool"
      resourceId: "filesystem_patch"
    effect: "deny"
    reason: "Filesystem patch is restricted to ./workspace directory"

  # Code Runner Python - Restricted tier, requires user approval
  - id: "standard-tool-code-runner-python"
    description: "Allow Python code runner (SecurityTier: RESTRICTED, requires approval)"
    priority: 700
    match:
      resource: "tool"
      resourceId: "code_runner_python"
    effect: "allow"
    audit: true
    require_approval: true

  # Code Runner JavaScript - Restricted tier, requires user approval
  - id: "standard-tool-code-runner-javascript"
    description: "Allow JavaScript code runner (SecurityTier: RESTRICTED, requires approval)"
    priority: 690
    match:
      resource: "tool"
      resourceId: "code_runner_javascript"
    effect: "allow"
    audit: true
    require_approval: true

  # ============================================================================
  # Network Access - Limited egress
  # ============================================================================

  # Allow network access to common domains
  - id: "standard-network-common-domains"
    description: "Allow network access to common domains"
    priority: 600
    match:
      resource: "network"
      action: "read"
    conditions:
      - field: "metadata.domain"
        operator: "in"
        value:
          - "github.com"
          - "docs.google.com"
          - "stackoverflow.com"
    effect: "allow"

  # Deny other network access
  - id: "standard-network-deny-other"
    description: "Deny network access to other domains"
    priority: 599
    match:
      resource: "network"
    effect: "deny"
    reason: "Network access is restricted to approved domains in standard mode"
